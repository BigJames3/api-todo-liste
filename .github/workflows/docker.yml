name: CI/CD Pipeline - Build, Push & Deploy Docker Image

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'

jobs:

  # 1 Unit Tests
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Run unit tests
        run: npm test


  # 2 Integration Tests (optionnel si tu en as)
  integration-tests:
    needs: unit-tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - run: npm install
      - run: npm run test:integration || echo "No integration tests"


  # 3 Build Application
  build:
    needs: integration-tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - run: npm install
      - run: npm run build


  # 4 Qualit√© de code - SonarCloud
  quality:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.projectName=${{ secrets.SONAR_PROJECT_NAME }}


  # 5 S√©curit√© Docker - Trivy
  security:
    needs: quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set Docker tag
        id: vars
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi

      - name: Build Docker image (local scan)
        run: docker build -t traorenignaman/api-todo-liste:${{ steps.vars.outputs.tag }} .

      - name: Trivy Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: traorenignaman/api-todo-liste:${{ steps.vars.outputs.tag }}
          severity: CRITICAL
          exit-code: 1


  # 6 Docker Build & Push
  docker:
    needs: security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set Docker tag
        id: vars
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker image
        run: docker build -t traorenignaman/api-todo-liste:${{ steps.vars.outputs.tag }} .

      - name: Push Docker image
        run: docker push traorenignaman/api-todo-liste:${{ steps.vars.outputs.tag }}

  
  # 7 DEPLOY (CD) - Ansible ‚Üí Azure VM
  deploy:
    name: Deploy to Azure VM
    needs: docker
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AZURE_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.AZURE_VM_IP }} >> ~/.ssh/known_hosts

      - name: Install Ansible
        run: |
          sudo apt update
          sudo apt install -y ansible

      - name: Set Docker tag
        id: vars
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi

      # üîç DEBUG ‚Äì √Ä AJOUTER ICI
      - name: Debug filesystem
        run: |
          echo "Current directory:"
          pwd
          echo "Repository tree:"
          ls -R

      # üöÄ DEPLOY
      - name: Deploy with Ansible
        working-directory: ansible   # ‚¨ÖÔ∏è LA SEULE DIFF√âRENCE
        env:
          DOCKER_IMAGE: traorenignaman/api-todo-liste
          DOCKER_TAG: latest
        run: |
         ansible-playbook playbooks/setup_vm.yml \
          -i inventory/production.ini \
          --extra-vars "docker_image=traorenignaman/api-todo-liste:latest"

         # ansible-playbook playbooks/setup_vm.yml \
          #  -i inventory/production.ini \
           # --extra-vars "docker_image=${DOCKER_IMAGE}:${DOCKER_TAG}"