# Nom du workflow affich√© dans GitHub Actions
name: Build and Push Docker Image

# D√©clenche le workflow automatiquement quand tu pushes sur la branche "main" & d'un tag
on:
  push:
    branches:
      - main # - push sur la branche main
    tags:
      - 'v*.*.*' # - push d'un tag commen√ßant par v (ex : v1.0.0)

# D√©finition des jobs (t√¢ches) √† ex√©cuter
jobs:
  build:
    # Machine virtuelle Ubuntu fournie par GitHub
    runs-on: ubuntu-latest

    # Liste des √©tapes du job
    steps:

      # √âtape 1 : R√©cup√©rer le code source du repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # √âtape 2 : Configurer Node.js (si n√©cessaire pour build)
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'   # Remplace par la version Node.js de ton projet

      # √âtape 3 : Installer les d√©pendances Node.js
      - name: Install dependencies
        run: npm install

      # √âtape 4 : Ex√©cuter les tests Jest avant de construire l'image Docker
      # Si un test √©choue ‚Üí l'image NE sera PAS construite (bonne pratique CI)
      # ‚úÖ Nouvelle √©tape : ex√©cuter les tests avant le build Docker
      - name: Run tests
        run: npm test

      # √âtape 5 : Compiler le code TypeScript (si ton projet utilise TS)
      - name: Build project
        run: npm run build   # g√©n√®re le dossier "dist" si tsconfig.json est configur√©


      # üîµ SonarCloud Scan
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2.1.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_SCANNER_OPTS: "-Xmx1024m"
        with:
          args: >
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.projectName=${{ secrets.SONAR_PROJECT_NAME }}
            
      # √âtape 6 : D√©terminer le bon TAG Docker
      # - Si push sur un tag "v1.2.3" ‚Üí image tag = "v1.2.3"
      # - Si push sur main ‚Üí image tag = "latest"
      - name: Set Docker Tag
        id: vars
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi

      # √âtape 7 : Se connecter √† Docker Hub avec les secrets GitHub
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}  # nom Docker Hub
          password: ${{ secrets.DOCKER_PASSWORD }}  # token g√©n√©r√© dans Docker Hub

      # √âtape  : Construire l'image Docker avec le TAG dynamique
      - name: Build Docker image
        run: docker build -t traorenignaman/api-todo-liste:${{ steps.vars.outputs.tag }} .


      # üîç 8Ô∏è‚É£ Scan de s√©curit√© avec Trivy
      - name: Security Scan with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'traorenignaman/api-todo-liste:${{ steps.vars.outputs.tag }}'
          format: 'table'
          exit-code: '1'      # Stop le workflow si des vuln√©rabilit√©s critiques sont trouv√©es
          severity: 'CRITICAL,HIGH'

      # √âtape 7 : Pousser l'image Docker vers Docker Hub
      - name: Push Docker image
        run: docker push traorenignaman/api-todo-liste:${{ steps.vars.outputs.tag }}
